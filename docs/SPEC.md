# SPEC: Local STT Service

## Обзор
CLI-инструмент для batch-транскрипции аудиофайлов в текст с автоматическим определением спикеров (диаризацией). Работает локально на GPU, оптимизирован для русского языка с вкраплениями английских терминов. Экспортирует результаты в JSON, TXT и SRT.

## Глоссарий

| Термин | Определение |
|--------|-------------|
| STT | Speech-to-Text — преобразование речи в текст |
| Транскрипция | Результат STT: текст с временными метками |
| Диаризация | Разделение аудио по спикерам ("кто говорил когда") |
| WER | Word Error Rate — доля ошибочных слов в транскрипции |
| DER | Diarization Error Rate — доля ошибок в разметке спикеров |
| Сегмент | Непрерывный фрагмент речи одного спикера |
| Code-switching | Переключение между языками в одной фразе |
| VAD | Voice Activity Detection — определение участков с речью |

## Допущения
- Аудио содержит речь (не музыку, не звуковые эффекты)
- Качество записи: Zoom/Meet уровень и выше (SNR > 15 dB)
- Спикеров от 1 до 8
- Основной язык — русский, с английскими техническими терминами
- Пользователь умеет работать с CLI и Python
- NVIDIA GPU с ≥ 10GB VRAM доступен

## Функциональные требования

### FR-1: Транскрипция аудио

**Связь с PRD:** G1

Система принимает аудиофайл и возвращает текст с временными метками на уровне сегментов.

**Acceptance Criteria:**
```gherkin
AC-1.1:
GIVEN аудиофайл с русской речью длительностью 10 минут
WHEN транскрипция
THEN результат содержит сегменты с полями: start, end, text
AND сегменты упорядочены по времени
AND текст содержит кириллицу

AC-1.2:
GIVEN файл в формате MP3 | WAV | FLAC | M4A | OGG | OPUS
WHEN транскрипция
THEN успешная обработка без ошибок

AC-1.3:
GIVEN аудио с русской речью и английскими терминами ("давайте обсудим deployment strategy")
WHEN транскрипция
THEN английские слова корректно транскрибированы латиницей

AC-1.4:
GIVEN повреждённый или неподдерживаемый файл
WHEN транскрипция
THEN понятное сообщение об ошибке в stderr
AND exit code != 0
```

---

### FR-2: Диаризация (разделение спикеров)

**Связь с PRD:** G2

Система определяет разных спикеров и помечает каждый сегмент идентификатором спикера.

**Acceptance Criteria:**
```gherkin
AC-2.1:
GIVEN аудио с 2+ голосами
WHEN транскрипция с диаризацией (режим по умолчанию)
THEN каждый сегмент имеет поле speaker с ID (SPEAKER_00, SPEAKER_01, ...)
AND разные голоса получают разные ID

AC-2.2:
GIVEN аудио с 1 спикером
WHEN транскрипция с диаризацией
THEN все сегменты имеют speaker = SPEAKER_00

AC-2.3:
GIVEN любой файл
WHEN транскрипция с флагом --no-diarize
THEN сегменты не содержат поле speaker
AND обработка быстрее (пропуск диаризации)

AC-2.4:
GIVEN аудио с известным числом спикеров
WHEN транскрипция с --num-speakers N
THEN диаризатор использует подсказку о числе спикеров
```

---

### FR-3: Форматы вывода

**Связь с PRD:** G1

Система экспортирует результат в нескольких форматах.

**Acceptance Criteria:**
```gherkin
AC-3.1:
GIVEN завершённая транскрипция
WHEN --format json (по умолчанию)
THEN создаётся JSON-файл со структурой: metadata + segments

AC-3.2:
GIVEN завершённая транскрипция
WHEN --format txt
THEN создаётся TXT-файл:
  "[HH:MM:SS] SPEAKER_00: текст сегмента"

AC-3.3:
GIVEN завершённая транскрипция
WHEN --format srt
THEN создаётся SRT-файл с валидной нумерацией и таймкодами

AC-3.4:
GIVEN завершённая транскрипция
WHEN --format json,txt,srt
THEN создаются 3 файла с соответствующими расширениями
AND имя файла = имя_исходного_аудио.{ext}

AC-3.5:
GIVEN транскрипция с диаризацией
WHEN экспорт в любой формат
THEN информация о спикере включена в вывод
```

Подробнее: [data-formats.md](data-formats.md)

---

### FR-4: Batch-обработка

**Связь с PRD:** G4

Система обрабатывает несколько файлов за один запуск.

**Acceptance Criteria:**
```gherkin
AC-4.1:
GIVEN директория с 5 аудиофайлами
WHEN batch-обработка директории
THEN 5 результатов в output-директории
AND прогресс отображается для каждого файла

AC-4.2:
GIVEN 5 файлов, 1 повреждён
WHEN batch-обработка
THEN 4 файла обработаны успешно
AND 1 ошибка залогирована
AND exit code отражает частичный успех

AC-4.3:
GIVEN директория с вложенными поддиректориями
WHEN batch с --recursive
THEN обрабатываются файлы во всех поддиректориях
AND структура директорий сохраняется в output
```

---

### FR-5: Выбор модели

**Связь с PRD:** G1, G5

Пользователь может выбрать размер STT-модели.

**Acceptance Criteria:**
```gherkin
AC-5.1:
GIVEN доступные модели: tiny, base, small, medium, large-v3, large-v3-turbo
WHEN --model large-v3 (по умолчанию)
THEN используется large-v3
AND модель автоматически скачивается при первом использовании

AC-5.2:
GIVEN модель ещё не скачана
WHEN первый запуск
THEN прогресс загрузки отображается
AND после загрузки модель кэшируется локально
```

---

### FR-6: Конфигурация

**Связь с PRD:** G3

**Acceptance Criteria:**
```gherkin
AC-6.1:
GIVEN файл конфигурации ./config.yaml
WHEN запуск без CLI-флагов
THEN применяются параметры из конфигурации

AC-6.2:
GIVEN конфигурация И CLI-флаги
WHEN запуск
THEN CLI-флаги имеют приоритет над конфигурацией
```

## Нефункциональные требования

### NFR-1: Производительность

| Метрика | Требование | Условия |
|---------|------------|---------|
| Время обработки | ≤ 0.3x длины аудио | GPU RTX 3090/4090, large-v3, с диаризацией |
| Время обработки | ≤ 0.1x длины аудио | GPU RTX 3090/4090, large-v3, без диаризации |
| Пиковое потребление VRAM | ≤ 12 GB | large-v3, float16 |

### NFR-2: Качество

| Метрика | Требование | Условия |
|---------|------------|---------|
| WER | < 10% | Чистая русская речь, хороший микрофон |
| WER | < 15% | Zoom/Meet записи, 2-5 спикеров |
| DER | < 20% | 2-5 спикеров, без overlap |

### NFR-3: Ресурсы

| Ресурс | Минимум | Рекомендуется |
|--------|---------|---------------|
| GPU VRAM | 10 GB (large-v3) | 24 GB |
| RAM | 8 GB | 16 GB |
| Дисковое пространство | 10 GB (модели) | 20 GB |

### NFR-4: Автономность
- Полная работа без интернета после первоначальной установки
- Все модели (STT + диаризация) хранятся локально
- Никакие данные не отправляются наружу

### NFR-5: Модульность
- STT-движок и диаризатор — отдельные компоненты
- Возможность замены диаризатора (pyannote → NeMo) без изменения CLI

### NFR-6: Надёжность
- Корректная обработка ошибок с информативными сообщениями
- Не теряет уже обработанные файлы при ошибке в batch
- Graceful shutdown при Ctrl+C (сохраняет текущий прогресс)

## Интерфейсы

### Входные данные

| Параметр | Тип | Обязательный | Ограничения |
|----------|-----|--------------|-------------|
| Аудиофайл(ы) | Файл / Директория | Да | MP3, WAV, FLAC, M4A, OGG, OPUS |
| Модель | Строка | Нет | tiny / base / small / medium / large-v3 / large-v3-turbo |
| Формат вывода | Строка | Нет | json / txt / srt (через запятую) |
| Язык | Строка | Нет | ru (по умолчанию), auto |
| Число спикеров | Число | Нет | 1-8, по умолчанию — автоопределение |

### Выходные данные
Подробнее: [data-formats.md](data-formats.md)

### Пользовательский интерфейс
Подробнее: [api.md](api.md)

## Ограничения системы
- Не real-time / не streaming
- Не идентифицирует спикеров по имени (только SPEAKER_00, SPEAKER_01)
- Overlapping speech — ограниченная точность диаризации
- Code-switching (ru↔en) может снижать точность на границах переключения

## Вне рамок v1.0
- Web-интерфейс — планируется v2
- REST API — планируется v2
- Абстракция диаризатора (pyannote ↔ NeMo) — планируется v2
- Постпроцессинг пунктуации — планируется v2
- Custom model training / fine-tuning

## Открытые вопросы

### Технические решения (принимаются в ADR)

| Вопрос | Варианты | Решение | ADR |
|--------|----------|---------|-----|
| STT-движок | faster-whisper, WhisperX, OpenAI Whisper | TBD | ADR-001 |
| Диаризатор | pyannote community-1, NeMo MSDD, NeMo Sortformer | TBD | ADR-001 |
| CLI-фреймворк | Typer, Click, argparse | TBD | ADR-001 |
| Модель Whisper | large-v3, large-v3-turbo, fine-tuned russian | TBD | ADR-001 |

## Связанные документы
- [PRD.md](PRD.md) — бизнес-контекст
- [api.md](api.md) — CLI-контракт
- [data-formats.md](data-formats.md) — форматы данных
