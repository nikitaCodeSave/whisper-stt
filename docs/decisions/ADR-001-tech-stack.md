# ADR-001: Технологический стек

**Статус:** Accepted
**Дата:** 2026-02-09
**Связь с SPEC:** FR-1, FR-2, FR-5, FR-6, NFR-1, NFR-2, NFR-4, NFR-5

## Контекст

Нужно выбрать STT-движок, диаризатор и CLI-фреймворк для локального сервиса транскрипции. Ключевое требование — качественная транскрипция русского языка с code-switching (ru↔en) и разделение спикеров, полностью офлайн после установки.

**Движущие факторы:**
- Максимальная точность для русского языка (WER < 10%)
- Диаризация с возможностью полностью локальной работы
- Скорость: обработка быстрее реального времени на RTX 3090/4090
- Модульность: возможность замены компонентов в будущем

**Ограничения:**
- NVIDIA GPU 24GB VRAM
- Pyannote модели gated — требуют HuggingFace token при первом скачивании
- NeMo ASR для русского уступает Whisper по точности

## Рассмотренные варианты

### STT-движок

#### Вариант A: faster-whisper (CTranslate2)

Оптимизированная реализация Whisper через CTranslate2. Поддерживает все модели Whisper, квантизацию, VAD.

| Критерий | Оценка |
|----------|--------|
| Скорость | + (до 4x быстрее оригинала) |
| VRAM | + (<8GB для large-v3 с beam_size=5) |
| Русский язык | + (WER ~9.84% stock, ~6.39% fine-tuned) |
| Word timestamps | + (нативно) |
| VAD | + (встроенный Silero VAD) |
| Сообщество | + (активное, 14k+ stars) |

**Плюсы:** максимальная скорость, низкое потребление VRAM, полный контроль над параметрами
**Минусы:** нет диаризации из коробки (нужен отдельный компонент)

#### Вариант B: WhisperX

Обёртка над faster-whisper с добавлением wav2vec2 alignment и pyannote диаризации.

| Критерий | Оценка |
|----------|--------|
| Скорость | + (faster-whisper backend) |
| Word timestamps | ++ (wav2vec2 forced alignment) |
| Диаризация | + (pyannote из коробки) |
| Зависимости | - (конфликты pyannote 3.0 + faster-whisper) |
| Гибкость | - (монолитная обёртка) |

**Плюсы:** всё в одном пакете, лучшие word-level timestamps
**Минусы:** известные конфликты зависимостей, сложнее заменить компоненты, всё равно зависит от pyannote HF token

#### Вариант C: Оригинальный OpenAI Whisper

Референсная реализация от OpenAI.

| Критерий | Оценка |
|----------|--------|
| Скорость | -- (в 4x медленнее faster-whisper) |
| VRAM | - (~10GB для large-v3) |
| Word timestamps | - (только segment-level) |
| Батчинг | - (нет нативного) |

**Плюсы:** официальная реализация
**Минусы:** значительно медленнее, нет практических преимуществ

### Диаризатор

#### Вариант A: Pyannote community-1

Новейшая открытая модель от pyannote. CC-BY-4.0, поддерживает офлайн через git clone.

| Критерий | Оценка |
|----------|--------|
| Точность | ++ (лучше 3.1 на бенчмарках) |
| Офлайн | + (git clone → локальный путь) |
| Простота | + (3 строки кода для запуска) |
| HF зависимость | ± (однократно при скачивании) |
| Overlap speech | + |
| Лицензия | + (CC-BY-4.0) |

**Плюсы:** лучшая точность среди открытых моделей, простая интеграция, поддержка офлайн
**Минусы:** однократно нужен HF token для скачивания модели

#### Вариант B: NeMo MSDD (Cascaded Diarization)

NVIDIA NeMo пайплайн: MarbleNet (VAD) + TitaNet (embeddings) + MSDD.

| Критерий | Оценка |
|----------|--------|
| Точность | + (конкурентная с pyannote) |
| Полностью локальный | ++ (NGC, без HF) |
| Простота | -- (сложная Hydra-конфигурация) |
| Русский ASR | - (Conformer CTC хуже Whisper) |
| Документация | ± (разрозненная) |
| Лицензия | + (Apache 2.0) |

**Плюсы:** полностью локальный без HF, enterprise-grade
**Минусы:** сложная конфигурация, тяжёлый фреймворк, хуже документирован для standalone использования

#### Вариант C: NeMo Sortformer (End-to-End)

Transformer-based end-to-end модель.

| Критерий | Оценка |
|----------|--------|
| Простота деплоя | + (одна модель) |
| Макс. спикеров | - (4 в текущей версии) |
| Быстрые реплики | - (хуже на коротких обменах) |
| Лицензия | -- (CC-BY-NC-4.0, non-commercial) |

**Плюсы:** простой деплой
**Минусы:** ограничение на 4 спикера, non-commercial лицензия, хуже на диалогах

### CLI-фреймворк

#### Вариант A: Typer

Современный CLI-фреймворк на основе type annotations.

| Критерий | Оценка |
|----------|--------|
| Type safety | ++ |
| Автодокументация | + (--help из аннотаций) |
| Rich output | + (интеграция с Rich) |
| Сообщество | + |

#### Вариант B: Click

Зрелый декораторный CLI-фреймворк.

| Критерий | Оценка |
|----------|--------|
| Зрелость | ++ |
| Гибкость | + |
| Boilerplate | - (больше декораторов) |

#### Вариант C: argparse

Стандартная библиотека Python.

| Критерий | Оценка |
|----------|--------|
| Зависимости | ++ (нет) |
| DX | -- (verbose, нет автодокументации) |

## Решение

### STT: faster-whisper

Максимальная скорость при той же точности. Модульность — диаризатор подключается отдельно. Нет конфликтов зависимостей, которые есть у WhisperX.

**Модель по умолчанию:** `large-v3` (float16). При необходимости — `large-v3-turbo` для ускорения или `antony66/whisper-large-v3-russian` для повышения точности на русском.

### Диаризация: pyannote community-1

Лучшая точность, простая интеграция, CC-BY-4.0 лицензия. Офлайн-сценарий решается через git clone модели при первой установке. NeMo MSDD остаётся как план B для v2 (абстракция диаризатора).

**Офлайн-стратегия:**
```bash
# При установке (нужен интернет + HF_TOKEN)
git clone https://hf.co/pyannote/speaker-diarization-community-1 ./models/pyannote/

# При работе (полностью офлайн)
pipeline = Pipeline.from_pretrained("./models/pyannote/")
```

### CLI: Typer

Современный, type-safe, автодокументация из аннотаций, интеграция с Rich для прогресс-баров.

### Полный стек

| Компонент | Технология | Версия |
|-----------|-----------|--------|
| Язык | Python | 3.11+ |
| STT | faster-whisper | latest |
| Диаризация | pyannote.audio (community-1) | 3.x |
| CLI | Typer | 0.x |
| Rich output | Rich | latest |
| Аудио | ffmpeg (системный) | 6.x+ |
| Конфигурация | PyYAML | latest |
| Package manager | pip | latest |

## Последствия

### Положительные
- Высокая скорость транскрипции (≤0.3x на RTX 3090)
- Лучшая точность для русского среди открытых моделей
- Модульная архитектура — легко заменить диаризатор в v2
- Typer обеспечивает качественный CLI UX без лишнего кода

### Отрицательные
- Pyannote требует однократной авторизации через HF_TOKEN при установке
- Два отдельных компонента (STT + диаризация) вместо one-click решения
- Alignment Whisper сегментов с pyannote диаризацией требует собственной логики

### Риски
- **Pyannote может изменить лицензию** — митигация: community-1 уже CC-BY-4.0, можно зафиксировать версию
- **Code-switching снижает точность** — митигация: тестирование на реальных записях, возможно initial_prompt для Whisper

## Связанные документы
- [SPEC.md](../SPEC.md) — функциональные требования
- [_discovery-log.md](../_discovery-log.md) — полное исследование вариантов
