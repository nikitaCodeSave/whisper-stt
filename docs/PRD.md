# PRD: Local STT Service (Whisper-based)

## Обзор

### Проблема
Облачные STT-сервисы не подходят для обработки конфиденциальных записей (звонки, внутренние совещания). Существующие локальные решения либо не поддерживают диаризацию из коробки, либо требуют сложной настройки с внешними зависимостями (HuggingFace авторизация для pyannote). Нет готового CLI-инструмента, который совмещает качественную транскрипцию русской речи с разделением спикеров и работает полностью локально.

### Решение
Локальный CLI-инструмент для batch-транскрипции аудио с автоматическим разделением спикеров. Работает на GPU, поддерживает русский язык с английскими вкраплениями, экспортирует результаты в JSON/TXT/SRT.

### Целевая аудитория
**Первичная:** Разработчики и технические специалисты с доступом к GPU-серверу
**Вторичная:** Аналитики, обрабатывающие записи звонков и совещаний

## Цели проекта

| ID | Цель | Связь с SPEC |
|----|------|--------------|
| G1 | Качественная транскрипция русской речи с поддержкой англ. терминов | → FR-1, NFR-2 |
| G2 | Автоматическое разделение спикеров (диаризация) | → FR-2 |
| G3 | Полностью локальная работа после первоначальной установки | → NFR-4 |
| G4 | Batch-обработка до 1 часа аудио в день | → FR-4 |
| G5 | Модульная архитектура: возможность замены STT-движка и диаризатора | → NFR-5 |

## Метрики успеха

| Метрика | Целевое значение | Как измерять |
|---------|------------------|--------------|
| WER (чистая речь, русский) | < 10% | Сравнение с ручной транскрипцией на 10 тестовых файлах |
| WER (Zoom/Meet записи) | < 15% | Те же условия |
| Diarization accuracy | > 85% DER | % правильно размеченных сегментов (2-5 спикеров) |
| Время обработки | ≤ 0.3x длины аудио | Замер на RTX 3090/4090, large-v3 |

## Scope

### В рамках проекта (In Scope)
- Batch-транскрипция аудиофайлов (MP3, WAV, FLAC, M4A, OGG, OPUS)
- Диаризация (разделение спикеров)
- Экспорт: JSON (с таймкодами и спикерами), TXT, SRT
- CLI-интерфейс
- Поддержка русского языка с английскими терминами

### MVP Scope

**Цель MVP:** рабочая транскрипция одного файла с диаризацией через CLI

| Функция | MVP | v2 | Обоснование |
|---------|-----|-----|-------------|
| Транскрипция одного файла | ✅ | ✅ | Core |
| Диаризация | ✅ | ✅ | Core |
| Экспорт JSON/TXT/SRT | ✅ | ✅ | Core |
| Batch-обработка директории | ❌ | ✅ | Можно через shell-скрипт |
| Абстракция диаризатора (pyannote/NeMo) | ❌ | ✅ | Достаточно одного варианта |
| Пре-процессинг аудио (нормализация) | ❌ | ✅ | Качество входа уже хорошее |
| REST API | ❌ | ✅ | CLI достаточно для MVP |

### Вне рамок проекта (Out of Scope)
- Real-time / streaming транскрипция
- Web/GUI интерфейс
- Идентификация спикеров по имени (только SPEAKER_00, SPEAKER_01)
- Облачный деплой
- Тренировка/дообучение моделей

### Будущие возможности (Future Scope)
- REST API (FastAPI)
- Docker-образ
- Абстракция над диаризатором (pyannote ↔ NeMo)
- Интеграция в RAG-пайплайн
- Пунктуация и капитализация (постпроцессинг)

## Ограничения и допущения

### Ограничения
- GPU обязателен (NVIDIA, 24GB VRAM)
- Первоначальная загрузка моделей ~10 GB (нужен интернет один раз)
- Pyannote требует однократной авторизации на HuggingFace для скачивания модели

### Допущения
- Пользователь умеет работать с CLI и Python
- Аудио содержит речь (не музыку)
- Качество записи: хорошие микрофоны / Zoom/Meet (SNR > 15 dB)
- Спикеров от 1 до 8
- Основной язык — русский, с английскими техническими терминами

## Риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Pyannote HF auth блокирует полностью офлайн-работу | Средняя | Высокое | community-1 модель + git clone для офлайн-использования |
| Низкая точность на code-switching (ru↔en) | Средняя | Среднее | Тестирование, возможно prompt engineering для Whisper |
| Конфликт зависимостей pyannote + faster-whisper | Средняя | Среднее | Фиксация версий, виртуальное окружение |
| NeMo MSDD сложен в настройке как альтернатива | Низкая | Среднее | Начать с pyannote, NeMo — план B |
| Sortformer лицензия CC-BY-NC (non-commercial) | Низкая | Среднее | Не использовать Sortformer, только MSDD или pyannote |

## Связанные документы

- [SPEC.md](SPEC.md) — функциональные требования
- [_discovery-log.md](_discovery-log.md) — лог исследования и сравнения реализаций
